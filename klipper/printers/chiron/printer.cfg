# Klipper Configuration - Anycubic Chiron
# Board: BTT SKR 3 EZ (STM32H743, 128KiB bootloader, USB)
# Toolhead: BTT EBB36 CAN (canbus_uuid: <YOUR_UUID>)
# Hotend: TZ E3 2.0 (V6 groove mount)
# Extruder: HGX Lite + FYSETC 36mm NEMA14 round body (on EBB36)
# Probe: BDsensor-M (EBB36 I2C, mesh only — optical endstop handles Z home)
# Bed: MIC-6 6mm 410x430mm, Keenovo AC silicone heater via Crydom D1D40 SSR
# Host: Raspberry Pi 5 4GB
# Input Shaping: ADXL345 built into EBB36
#
# ⚠️  Pin assignments marked "verify" must be confirmed against BTT SKR 3 EZ pinout PDF
#    (available at github.com/bigtreetech/SKR-3)
#
# ⚠️  EBB36 pin assignments must be confirmed against BTT EBB36 v1.2 pinout diagram
#    (available at github.com/bigtreetech/EBB)
#
# ⚠️  Values marked <PLACEHOLDER> must be filled in after physical installation:
#    - <YOUR_SERIAL>: discovered via: ls /dev/serial/by-id/
#    - <YOUR_EBB36_UUID>: discovered via: ~/klippy-env/bin/python ~/klipper/scripts/canbus_query.py can0
#    - <X_OFFSET>, <Y_OFFSET>: measure BDsensor-to-nozzle distance after mounting toolhead
#    - <Z_LEFT_X>, <Z_RIGHT_X>: measure leadscrew positions with calipers (Task 1)
#    - <FILAMENT_SENSOR_PIN>: verify EBB36 v1.2 pinout
#
# Boot checklist (in order after hardware install — requires Tasks 12-14 config sections):
#   1. QUERY_ENDSTOPS — verify X, Y, Z trigger correctly
#   2. G28 with hand on e-stop — verify all axes home safely
#   3. PROBE_ACCURACY — verify BDsensor std dev < 0.010mm
#   4. Z_TILT_ADJUST standalone — confirm both Z motors move and converge
#   5. BED_MESH_CALIBRATE PROFILE=initial
#   6. PROBE_CALIBRATE — paper test, set z_offset
#   7. SAVE_CONFIG
#   8. PID_CALIBRATE HEATER=extruder TARGET=220
#   9. PID_CALIBRATE HEATER=heater_bed TARGET=60
#  10. SAVE_CONFIG
#  11. SHAPER_CALIBRATE
#  12. First print at conservative speeds

# ----------------- INCLUDES -----------------
[include mainsail.cfg]
[include KAMP_Settings.cfg]
[include start.cfg]
[include macros.cfg]

# ----------------- MCU AND CANBUS -----------------
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h743xx_<YOUR_SERIAL>-if00

[mcu EBBCan]
canbus_uuid: <YOUR_EBB36_UUID>

[mcu rpi]
serial: /tmp/klipper_host_mcu

# ----------------- PRINTER -----------------
[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000        # Conservative starting value — tune after input shaper
max_z_velocity: 10
max_z_accel: 100
square_corner_velocity: 5.0

# ----------------- TEMPERATURE SENSORS -----------------
[temperature_sensor EBBCan]
sensor_type: temperature_mcu
sensor_mcu: EBBCan
min_temp: 0
max_temp: 100

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

# ----------------- STEPPERS -----------------
[stepper_x]
step_pin: PF13          # SKR 3 EZ M1 STEP — verify against BTT SKR 3 EZ pinout PDF
dir_pin: PF12           # SKR 3 EZ M1 DIR — verify
enable_pin: !PF14       # SKR 3 EZ M1 EN — verify
microsteps: 16
rotation_distance: 40   # Standard 2GT belt, 20T pulley
endstop_pin: EBBCan:PB6 # X endstop on toolhead (EBB36 v1.2) — verify EBB36 pinout
position_endstop: 0
position_max: 400       # Chiron X build volume
homing_speed: 50

[tmc2209 stepper_x]
uart_pin: PC4           # SKR 3 EZ M1 UART — verify
run_current: 0.800
stealthchop_threshold: 0    # SpreadCycle for X axis

[stepper_y]
step_pin: PG0           # SKR 3 EZ M2 STEP — verify
dir_pin: PG1            # SKR 3 EZ M2 DIR — verify
enable_pin: !PF15       # SKR 3 EZ M2 EN — verify
microsteps: 16
rotation_distance: 40
endstop_pin: PG9        # SKR 3 EZ Y endstop — verify
position_endstop: 0
position_max: 430       # Chiron Y build volume (bed depth)
homing_speed: 50

[tmc2209 stepper_y]
uart_pin: PD11          # SKR 3 EZ M2 UART — verify
run_current: 0.800
stealthchop_threshold: 0    # SpreadCycle for Y axis

# Z left leadscrew (SKR 3 EZ M3)
[stepper_z]
step_pin: PF11          # SKR 3 EZ M3 STEP — verify
dir_pin: !PG3           # SKR 3 EZ M3 DIR — verify polarity (! may need removal)
enable_pin: !PG5        # SKR 3 EZ M3 EN — verify
rotation_distance: 8    # T8 leadscrew, 8mm pitch (standard Chiron)
microsteps: 16
endstop_pin: PG10       # SKR 3 EZ Z optical endstop — verify
position_endstop: 0
position_min: -3
position_max: 450       # Chiron Z build volume
homing_speed: 10
second_homing_speed: 3
homing_retract_dist: 5
homing_retract_speed: 5

[tmc2209 stepper_z]
uart_pin: PC6           # SKR 3 EZ M3 UART — verify
run_current: 0.650
stealthchop_threshold: 999999   # StealthChop for Z (low-speed, smooth)
interpolate: False              # Disable 256x interpolation — improves Z_TILT accuracy

# Z right leadscrew (SKR 3 EZ M4) — no endstop, controlled by Z_TILT_ADJUST
[stepper_z1]
step_pin: PG4           # SKR 3 EZ M4 STEP — verify
dir_pin: PC1            # SKR 3 EZ M4 DIR — verify polarity
enable_pin: !PA0        # SKR 3 EZ M4 EN — verify
rotation_distance: 8
microsteps: 16

[tmc2209 stepper_z1]
uart_pin: PC7           # SKR 3 EZ M4 UART — verify
run_current: 0.650
stealthchop_threshold: 999999
interpolate: False              # Disable 256x interpolation — improves Z_TILT accuracy

# ----------------- EXTRUDER -----------------
[extruder]
step_pin: EBBCan:PD0
dir_pin: EBBCan:PD1
enable_pin: !EBBCan:PD2
microsteps: 16
rotation_distance: 47.088   # HGX Lite 7.5:1 gear ratio base — calibrate with 100mm test
gear_ratio: 7.5:1
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: EBBCan:PB13
sensor_type: ATC Semitec 104GT-2  # TZ E3 2.0 standard thermistor — verify
sensor_pin: EBBCan:PA3
min_temp: 0
max_temp: 300
max_extrude_only_distance: 200.0
max_extrude_cross_section: 5    # Required for KAMP LINE_PURGE
min_extrude_temp: 170
pressure_advance: 0.04          # Starting value — tune with PA tower

[tmc2209 extruder]
uart_pin: EBBCan:PA15
run_current: 0.650
stealthchop_threshold: 0        # SpreadCycle — required for direct drive consistency

# ----------------- FIRMWARE RETRACTION -----------------
[firmware_retraction]
retract_length: 0.6     # Direct drive
retract_speed: 40
unretract_extra_length: 0
unretract_speed: 40

# ----------------- HEATER BED -----------------
[heater_bed]
heater_pin: PD7             # SKR 3 EZ HB pin — verify
sensor_type: Generic 3950   # Keenovo NTC 100K thermistor
sensor_pin: PA1             # SKR 3 EZ TB pin — verify
min_temp: 0
max_temp: 130
pwm_cycle_time: 0.0166      # 60Hz AC / 120VAC (North America)
# PID values from PID_CALIBRATE — expect high Kp/Kd due to 6mm aluminum thermal mass
# Run: PID_CALIBRATE HEATER=heater_bed TARGET=60 (will take 20-40 minutes)

# ----------------- FANS -----------------
[heater_fan heatbreak_cooling_fan]
pin: EBBCan:PA0             # EBB36 v1.2 fan output — verify
heater: extruder
heater_temp: 50.0

[fan]
pin: EBBCan:PA2             # EBB36 v1.2 part cooling fan output — verify

[heater_fan controller_fan]
pin: PD15                   # SKR 3 EZ FAN2 — verify
