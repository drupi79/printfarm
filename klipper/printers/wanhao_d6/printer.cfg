# Klipper Configuration - Wanhao Duplicator 6
# Board: BTT SKR Mini E3 v3.0 (STM32G0B1, 8KiB bootloader, USB)
# Toolhead: BTT EBB42 CAN (canbus_uuid: 799e85ba0b4e)
# Hotend: HICTOP Bambu Lab X1 Carbon Assembly, hardened steel 0.4mm nozzle
# Extruder: BMG direct drive on EBBCan (gear_ratio 57:11)
# Probe: BDsensor (EBBCan pins, x_offset=0, y_offset=-13)
# Input Shaping: EI @ 36.0Hz (X), MZV @ 30.4Hz (Y)
#
# CHANGES FROM BACKUP (2026-02-20):
# 1. probe_count: 50,50 → 9,9  [CRITICAL - was ~83 minutes per mesh!]
# 2. safe_z_home: 100,113 → 110,123  [nozzle now at true bed center (110,110)]
# 3. zero_reference_position: 100,113 → 110,110  [BUG FIX - must be probe coords, not nozzle coords]
# 4. firmware_retraction: 2mm → 0.6mm  [BMG is direct drive, not Bowden!]
# 5. gcode_arcs resolution: 1.0 → 0.1  [smoother arc interpolation]
# 6. [input_shaper] moved from SAVE_CONFIG to active config section (reverted by #12)
# 7. Duplicate [include timelapse.cfg] removed
# 8. [exclude_object] removed (handled by shared start.cfg)
# 9. bed_mesh: added fade_start/fade_end
# 10. D6 own start.cfg/macros.cfg replaced with shared versions
#
# CHANGES (2026-02-24):
# 11. Extruder TMC stealthchop_threshold: 999999 → 0  [SpreadCycle for direct drive consistency]
# 12. [input_shaper] removed from active config — SAVE_CONFIG owns it (avoids silent override)
# 13. NeoPixel sections commented out (not yet implemented)
# 14. Layout updated to match farm config style
# 15. sensor_type: EPCOS 100K B57560G104F → Generic 3950  [Bambu hotend uses NTC 100K 3950K B-value]
#     ⚠️  Re-run PID_CALIBRATE HEATER=extruder after deploying — temperature readings will shift
#
# ⚠️  Z rotation_distance: 4 — original D6 leadscrew is 8mm pitch.
#    rotation_distance: 4 means it was either swapped for a 4mm pitch screw
#    OR calibrated down (e.g. double-start 2mm pitch = 4mm travel/rev).
#    Kept as-is since it's been running. If Z moves wrong distance, revert to 8.
#
# ⚠️  Extruder rotation_distance: 38.344 with gear_ratio 57:11 (5.18:1)
#    Effective drive distance = 38.344 / 5.18 ≈ 7.4mm — reasonable for BMG.
#    Comment says "Previously 32.495" — current value appears calibrated.

# ----------------- INCLUDES -----------------
[include mainsail.cfg]
[include KAMP_Settings.cfg]
[include timelapse.cfg]
[include start.cfg]
[include macros.cfg]

# ----------------- MCU AND CANBUS -----------------
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_2200060015504D5930393520-if00

[mcu EBBCan]
canbus_uuid: 799e85ba0b4e

[mcu rpi]
serial: /tmp/klipper_host_mcu

# ----------------- PRINTER -----------------
[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 3900        # Supported by input shaping (EI @ 36Hz X, MZV @ 30.4Hz Y)
max_z_velocity: 5
max_z_accel: 100
square_corner_velocity: 5.0

# ----------------- RESONANCE TESTER -----------------
[adxl345]
cs_pin: EBBCan:PB12
spi_software_sclk_pin: EBBCan:PB10
spi_software_mosi_pin: EBBCan:PB11
spi_software_miso_pin: EBBCan:PB2

[resonance_tester]
accel_chip: adxl345
probe_points: 110, 110, 20

# ----------------- TEMPERATURE SENSORS -----------------
[temperature_sensor EBBCan]
sensor_type: temperature_mcu
sensor_mcu: EBBCan
min_temp: 0
max_temp: 100

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

# ----------------- STEPPERS -----------------
[stepper_x]
step_pin: PB13
dir_pin: !PB12
enable_pin: !PB14
microsteps: 16
rotation_distance: 40
endstop_pin: ^!PC0
position_endstop: 0
position_max: 220
homing_speed: 50

[tmc2209 stepper_x]
uart_pin: PC11
tx_pin: PC10
uart_address: 0
run_current: 0.580
stealthchop_threshold: 999999

[stepper_y]
step_pin: PB10
dir_pin: PB2
enable_pin: !PB11
microsteps: 16
rotation_distance: 40
endstop_pin: ^!PC1
position_endstop: 0
position_max: 220
homing_speed: 50

[tmc2209 stepper_y]
uart_pin: PC11
tx_pin: PC10
uart_address: 2
run_current: 0.580
stealthchop_threshold: 999999

# ⚠️  rotation_distance: 4 — see note at top of file
[stepper_z]
step_pin: PB0
dir_pin: !PC5
enable_pin: !PB1
microsteps: 16
rotation_distance: 4
endstop_pin: probe:z_virtual_endstop
homing_speed: 5
second_homing_speed: 3
homing_retract_speed: 2
homing_retract_dist: 5
position_max: 175
position_min: -3

[tmc2209 stepper_z]
uart_pin: PC11
tx_pin: PC10
uart_address: 1
run_current: 0.580
stealthchop_threshold: 999999

# ----------------- EXTRUDER -----------------
[extruder]
step_pin: EBBCan:PD0
dir_pin: EBBCan:PD1
enable_pin: !EBBCan:PD2
microsteps: 16
rotation_distance: 38.344    # Calibrated (was 32.495). Effective: ~7.4mm/rev with 57:11 ratio
gear_ratio: 57:11            # BMG gear ratio
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: EBBCan:PB13
sensor_type: Generic 3950          # Bambu Lab X1C hotend: NTC 100K, B-value 3950K
sensor_pin: EBBCan:PA3
min_temp: 0
max_temp: 300
max_extrude_only_distance: 200.0
max_extrude_cross_section: 5    # Required for KAMP LINE_PURGE
min_extrude_temp: 170
pressure_advance: 0.05          # Starting value - tune with PA_CALIBRATE

[tmc2209 extruder]
uart_pin: EBBCan:PA15
run_current: 0.650
stealthchop_threshold: 0       # SpreadCycle — required for direct drive extrusion consistency

# ----------------- FIRMWARE RETRACTION -----------------
[firmware_retraction]
retract_length: 0.6    # Direct drive — was 2mm (Bowden length)
retract_speed: 40
unretract_extra_length: 0
unretract_speed: 40

# ----------------- HEATER BED -----------------
[heater_bed]
heater_pin: PC9
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 130

# ----------------- FANS -----------------
[heater_fan heatbreak_cooling_fan]
pin: EBBCan:PA0

[heater_fan controller_fan]
pin: PB15

[fan]
pin: PC6

# ----------------- LEDS -----------------
# NeoPixels not yet wired — uncomment and set chain_count when installed
#[neopixel hotend_leds]
#pin: EBBCan:PD3
#chain_count: 1
#color_order: GRB

#[neopixel mcu_leds]
#pin: PA8
#chain_count: 1
#color_order: GRB

[output_pin LED]
pin: rpi:gpio18
pwm: True
cycle_time: 0.010
value: 0

# ----------------- BDSENSOR -----------------
# Offset: x=0, y=-13 (probe is 13mm behind nozzle in the -Y direction)
# At safe_z_home nozzle pos (110,123): probe lands at (110+0, 123-13) = (110,110) = bed center ✓
[BDsensor]
sda_pin: EBBCan:PB8
scl_pin: EBBCan:PB9
delay: 10
x_offset: 0
y_offset: -13
no_stop_probe:              # Fast probing — comment out if getting mesh errors
position_endstop: 1.2
collision_homing: 1
collision_calibrate: 1
speed: 3
homing_cmd: G28
rt_sample_time: 25      # Enables RTL — samples Z every 25ms during print (hybrid mode: mesh + RTL)

# ----------------- HOMING -----------------
# safe_z_home uses NOZZLE coordinates.
# home_xy_position = nozzle position where probe lands at bed center (110,110)
# Nozzle X: 110 + 0 = 110 | Nozzle Y: 110 - (-13) = 123
[safe_z_home]
home_xy_position: 110, 123
z_hop: 5
z_hop_speed: 5

# ----------------- BED MESH -----------------
# Limits are in PROBE coordinates (probe_pos = nozzle_pos + offset)
# BDsensor offset: x+0, y-13
#   mesh_min X=5:   nozzle at X=5  (5mm from left edge) ✓
#   mesh_min Y=5:   nozzle at Y=18 (18mm from front edge) ✓
#   mesh_max X=195: nozzle at X=195 (25mm from right edge) ✓
#   mesh_max Y=187: nozzle at Y=200 (20mm from rear edge) ✓
# zero_reference_position = probe coords when nozzle is at safe_z_home (110,123)
#   probe_x = 110+0 = 110 | probe_y = 123+(-13) = 110 ✓
[bed_mesh]
speed: 120
horizontal_move_z: 1
zero_reference_position: 110, 110
mesh_min: 5, 5
mesh_max: 195, 187
probe_count: 9, 9           # 81 points ~3 min. Was 50,50 = 2500 points (~83 min!)
algorithm: bicubic
fade_start: 1
fade_end: 10
fade_target: 0

# ----------------- BED SCREWS -----------------
[screws_tilt_adjust]
screw1: 92, 0
screw1_name: front center screw
screw2: 152, 190
screw2_name: rear right screw
screw3: 33, 190
screw3_name: rear left screw

# ----------------- MISC -----------------
[virtual_sdcard]
path: /home/pi/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[force_move]
enable_force_move: true

[gcode_arcs]
resolution: 0.1

[board_pins]
aliases:
    EXP1_1=PB5,  EXP1_3=PA9,   EXP1_5=PA10, EXP1_7=PB8, EXP1_9=<GND>,
    EXP1_2=PA15, EXP1_4=<RST>, EXP1_6=PB9,  EXP1_8=PD6, EXP1_10=<5V>

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 29.068
#*# pid_ki = 9.228
#*# pid_kd = 22.891
#*#
#*# [input_shaper]
#*# shaper_type_x = ei
#*# shaper_freq_x = 36.0
#*# shaper_type_y = mzv
#*# shaper_freq_y = 30.4
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 68.897
#*# pid_ki = 2.926
#*# pid_kd = 405.632
#*#
#*# [BDsensor]
#*# z_offset = -0.155
