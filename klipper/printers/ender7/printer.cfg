# Ender 7 - Klipper Configuration - OPTIMIZED
# Hardware: CoreXY | BDsensor | TZ E3 2.0 Hotend | HGX Lite Extruder
# Host: Raspberry Pi 5 4GB
# Board: STM32F103 (28KiB bootloader, USART1 PA10/PA9)
#
# CHANGES FROM ORIGINAL:
# 1. probe_count: 50,50 → 9,9  [CRITICAL - was ~83 minutes per mesh!]
# 2. safe_z_home: 125,125 → 130,130  [nozzle now at true bed center]
# 3. zero_reference_position: 125,125 → 165.5,104.5  [probe coords at nozzle center]
# 4. mesh_min: 36,26 → 40,5  [better front coverage with correct Y math]
# 5. mesh_max: 222,224 → 255,230  [extended X coverage by 33mm]
# 6. [input_shaper] removed from active config — SAVE_CONFIG owns it (avoids silent override)
#    Calibrated 2026-02-27: X=MZV@63.2Hz, Y=3hump_ei@82.2Hz (resolved 106Hz anomaly)
# 7. CANCEL_PRINT: parks at X0 → X5  [was slamming into X endstop]
# 8. [firmware_retraction] section added
# 9. [gcode_arcs] added (resolution 0.1mm)
# 10. pressure_advance starting value added (0.04 for HGX Lite direct drive)
# 11. Load/Unload distances corrected for direct drive (was set for Bowden)
# 12. SAVE_CONFIG bed mesh cleared (last 2 rows were corrupted - re-run BED_MESH_CALIBRATE)
# 13. [exclude_object] removed (already in start.cfg)
# 14. Added [include macros.cfg]
#
# HGX LITE ROTATION_DISTANCE: 5.7 — verified by 100mm extrusion test.

[include mainsail.cfg]
[include start.cfg]
[include macros.cfg]
[include KAMP_Settings.cfg]
#[include adxlmcu.cfg]

# ----------------- STEPPERS -----------------
[stepper_x]
step_pin: PC2
dir_pin: PB9
enable_pin: !PC3
microsteps: 32
rotation_distance: 32
endstop_pin: ^PA5
position_endstop: 0
position_max: 260
homing_speed: 50

[stepper_y]
step_pin: PB8
dir_pin: !PB7
enable_pin: !PC3
microsteps: 32
rotation_distance: 32
endstop_pin: ^PA6
position_endstop: 260
position_max: 260
homing_speed: 50

[stepper_z]
step_pin: PB6
dir_pin: PB5
enable_pin: !PC3
rotation_distance: 8
microsteps: 16
endstop_pin: probe:z_virtual_endstop
homing_speed: 5
second_homing_speed: 3
homing_retract_speed: 2
homing_retract_dist: 5
position_min: -3.5
position_max: 280

# ----------------- EXTRUDER -----------------
[extruder]
max_extrude_only_distance: 200.0
min_extrude_temp: 170
step_pin: PB4
dir_pin: !PB3
enable_pin: !PC3
microsteps: 16
rotation_distance: 5.7          # Verified by 100mm extrusion test
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 320
max_extrude_cross_section: 10
pressure_advance: 0.04           # Starting value for HGX Lite direct drive - tune with PA tower

[heater_bed]
heater_pin: PA15
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 100

[fan]
pin: PA0

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[mcu rpi]
serial: /tmp/klipper_host_mcu

[filament_switch_sensor filament_sensor]
pause_on_runout: true
switch_pin: !PA4

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 4400         # Supported by input shaping (MZV @ 63.2Hz X, 3hump_ei @ 82.2Hz Y)
max_z_velocity: 20
max_z_accel: 500

[gcode_arcs]
resolution: 0.1

[firmware_retraction]
retract_length: 0.6             # HGX Lite direct drive - adjust via tower test
retract_speed: 40
unretract_speed: 35
unretract_extra_length: 0

# ----------------- BDSENSOR -----------------
[BDsensor]
sda_pin: ^PB1
scl_pin: PB0
delay: 10
z_offset: 0                     # Adjust via PROBE_CALIBRATE
x_offset: 35.5
y_offset: -25.5
no_stop_probe:                  # Fast probing - comment out if getting mesh errors
position_endstop: 1.2
collision_homing: 1
collision_calibrate: 1
speed: 3
homing_cmd: G28
rt_sample_time: 19      # Enables RTL — samples Z every 19ms during print (hybrid mode: mesh + RTL)

#[bltouch]                      # Kept as reference - BDsensor is active
#sensor_pin: ^PB1
#control_pin: PB0
#x_offset: 35.5
#y_offset: -25.5

# ----------------- HOMING -----------------
# safe_z_home uses NOZZLE coordinates.
# To probe at bed center (130,130): nozzle must be at 130,130.
# Probe will land at: 130+35.5=165.5 (X), 130-25.5=104.5 (Y).
# Original was 125,125 → probe landed off-center at 160.5,99.5.
[safe_z_home]
home_xy_position: 130, 130      # Nozzle at true bed center (130,130 for 260x260)
speed: 80
z_hop: 10
z_hop_speed: 10

[force_move]
enable_force_move: true

# ----------------- BED MESH -----------------
# PROBE COUNT: Was 50x50 = 2500 points (~83 minutes). Now 9x9 = 81 points (~3 min).
# LIMITS: In PROBE coordinates (probe_pos = nozzle_pos + offset).
#   BDsensor offset: x+35.5, y-25.5
#   mesh_min X=40: nozzle at X=4.5 (5mm margin from edge) ✓
#   mesh_min Y=5:  nozzle at Y=30.5 (5mm from edge after Y offset math) ✓
#   mesh_max X=255: nozzle at X=219.5 (probe stays on bed) ✓
#   mesh_max Y=230: nozzle at Y=255.5 (5mm margin from Y=260 edge) ✓
# ZERO REFERENCE: probe coords when nozzle is at bed center (130,130).
#   probe_x = 130 + 35.5 = 165.5, probe_y = 130 - 25.5 = 104.5
[bed_mesh]
speed: 200
horizontal_move_z: 1
zero_reference_position: 165.5, 104.5   # Probe position when nozzle at bed center
mesh_min: 40, 5
mesh_max: 255, 230
probe_count: 9, 9                        # 81 points. Use 11,11 for max detail.
algorithm: bicubic
bicubic_tension: 0.2
fade_start: 1
fade_end: 10
fade_target: 0

# ----------------- BED SCREWS -----------------
[screws_tilt_adjust]
screw1: 0, 13
screw1_name: front left screw
screw2: 185, 13
screw2_name: front right screw
screw3: 185, 204
screw3_name: rear right screw
screw4: 0, 204
screw4_name: rear left screw
horizontal_move_z: 10
speed: 200
screw_thread: CW-M4


#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 39.679
#*# pid_ki = 9.447
#*# pid_kd = 41.663
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 76.667
#*# pid_ki = 1.597
#*# pid_kd = 920.002
#*#
#*# [BDsensor]
#*# z_offset = 0
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 63.2
#*# shaper_type_y = 3hump_ei
#*# shaper_freq_y = 82.2
