# Optimized Klipper Configuration - Elegoo Neptune 3 Max
# Board: ZNP Robin Nano DW v2.2 (STM32F401)
# Hotend: Slice Engineering Copperhead
# Probe: Stock inductive proximity sensor
# Input Shaping: Calibrated (mzv @ 52.2Hz X, ei @ 40.0Hz Y)

#====================================================================
# INCLUDES
#====================================================================
[include mainsail.cfg]
[include timelapse.cfg]
[include KAMP_Settings.cfg]
[include start.cfg]    # Shared with Enders
[include macros.cfg]   # Shared with Enders
#[include adxlmcu.cfg] # Uncomment for resonance testing

#====================================================================
# CORE SERVICES
#====================================================================
[virtual_sdcard]
path: /home/pi/printer_data/gcodes

[display_status]

#====================================================================
# TEMPERATURE SENSORS
#====================================================================
[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#====================================================================
# MCU
#====================================================================
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

#====================================================================
# PRINTER KINEMATICS
#====================================================================
[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 3000          # Supported by input shaping (ei @ 40Hz Y)
max_z_velocity: 15
max_z_accel: 100
square_corner_velocity: 5

#====================================================================
# LED
#====================================================================
[led LED_Light]
white_pin: PB9
initial_white: 1.0

#====================================================================
# STEPPER MOTORS
#====================================================================
[stepper_x]
step_pin: !PC12
dir_pin: PB3
enable_pin: !PD2
microsteps: 16
rotation_distance: 40
endstop_pin: PA13
position_endstop: 0
position_min: 0
position_max: 430
homing_speed: 100

[stepper_y]
step_pin: PC11
dir_pin: PA15
enable_pin: !PC10
microsteps: 16
rotation_distance: 40
endstop_pin: PB8
position_endstop: -6
position_min: -6
position_max: 430
homing_speed: 50

[stepper_z]
step_pin: PC7
dir_pin: !PC9
enable_pin: !PC8
rotation_distance: 8
microsteps: 16
position_min: -6
position_max: 506
endstop_pin: probe:z_virtual_endstop
homing_speed: 10
homing_retract_speed: 15

#====================================================================
# EXTRUDER - DIRECT DRIVE + COPPERHEAD HOTEND
#====================================================================
[extruder]
step_pin: PB10
dir_pin: PB1
enable_pin: !PC6
microsteps: 16
rotation_distance: 7.65       # Your calibrated value
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA6
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC1
min_temp: 0
max_temp: 300                  # Copperhead supports high temps
max_extrude_only_distance: 100.0
max_extrude_cross_section: 5   # Required for KAMP LINE_PURGE
min_extrude_temp: 0
pressure_advance: 0.05         # Starting value - tune with PA_CALIBRATE

#====================================================================
# FIRMWARE RETRACTION - Direct Drive
#====================================================================
[firmware_retraction]
retract_length: 0.6   # Direct drive! Was 2mm - critical fix
retract_speed: 40
unretract_extra_length: 0
unretract_speed: 40

#====================================================================
# HEATED BED
#====================================================================
[heater_bed]
heater_pin: PA5
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC0
pwm_cycle_time: 0.020  # Change to 0.0166 for 60Hz grid to fix flickering
max_temp: 110
min_temp: 0

#====================================================================
# FANS
#====================================================================
[fan]
pin: PA7

[heater_fan hotend_fan]
pin: PB0
heater: extruder
heater_temp: 50.0

#====================================================================
# PROBE
#====================================================================
[probe]
pin: ^PA8
speed: 5
lift_speed: 15
samples: 3
x_offset: -28.5
y_offset: 22

#====================================================================
# HOMING & BED LEVELING
#====================================================================
[safe_z_home]
home_xy_position: 243.5, 193  # Corrected: center (215,215) + probe offset (28.5,-22)
z_hop: 10
speed: 100.0

[bed_mesh]
speed: 200
horizontal_move_z: 10
mesh_min: 33, 16
mesh_max: 397, 415
probe_count: 9, 7
algorithm: bicubic
fade_start: 1.0
fade_end: 10.0

[screws_tilt_adjust]
screw_thread: CW-M3
speed: 200
screw1: 243.5, 193
screw1_name: center
screw2: 421, 370.5
screw2_name: right back screw
screw3: 421, 193
screw3_name: right middle screw
screw4: 421, 15.5
screw4_name: right front screw
screw5: 66, 15.5
screw5_name: left front screw
screw6: 66, 193
screw6_name: left middle screw
screw7: 66, 370.5
screw7_name: left back screw

#====================================================================
# INPUT SHAPING (Calibrated)
#====================================================================
[input_shaper]
shaper_type_x: mzv
shaper_freq_x: 52.2
shaper_type_y: ei
shaper_freq_y: 40.0

#====================================================================
# FILAMENT SENSOR (Active)
#====================================================================
[filament_switch_sensor filament_sensor]
pause_on_runout: true
switch_pin: PB4

#====================================================================
# MISC
#====================================================================
[force_move]
enable_force_move: True

[gcode_arcs]
resolution: 0.1  # Improved from 1.0 for smoother curves

#====================================================================
# SAVE CONFIG
#====================================================================
#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 0.341
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 25.742
#*# pid_ki = 1.384
#*# pid_kd = 119.701
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 74.382
#*# pid_ki = 1.025
#*# pid_kd = 1350.037
#*#
#*# [input_shaper]
#*# shaper_type_y = ei
#*# shaper_freq_y = 40.0
#*# shaper_type_x = mzv
#*# shaper_freq_x = 52.2
