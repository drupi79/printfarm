# Klipper Macros - Shared across all printers
# Custom macros for filament management, preheating, PID calibration, and print control

#====================================================================
# FILAMENT MANAGEMENT
#====================================================================

[gcode_macro LOAD_FILAMENT]
description: Load filament into the extruder
gcode:
    M83  # Extruder relative mode
    G1 E50 F300  # Fast load
    G1 E30 F150  # Slow purge
    M82  # Extruder absolute mode

[gcode_macro UNLOAD_FILAMENT]
description: Unload filament from the extruder
gcode:
    M83  # Extruder relative mode
    G1 E10 F300  # Push a bit to ensure grip
    G1 E-80 F1000  # Fast unload
    M82  # Extruder absolute mode

#====================================================================
# PREHEAT PRESETS
#====================================================================

[gcode_macro PREHEAT_PLA]
description: Preheat for PLA with 10 minute heat soak
gcode:
    M140 S60   # Start bed heating
    M104 S200  # Start extruder heating
    M190 S60   # Wait for bed to reach temp
    M109 S200  # Wait for extruder to reach temp
    RESPOND MSG="Heat soak starting - waiting 10 minutes..."
    G4 P600000 # Wait 10 minutes (600,000ms)
    RESPOND MSG="Heat soak complete!"

[gcode_macro PREHEAT_PETG]
description: Preheat for PETG with 10 minute heat soak
gcode:
    M140 S80   # Start bed heating
    M104 S240  # Start extruder heating
    M190 S80   # Wait for bed to reach temp
    M109 S240  # Wait for extruder to reach temp
    RESPOND MSG="Heat soak starting - waiting 10 minutes..."
    G4 P600000 # Wait 10 minutes (600,000ms)
    RESPOND MSG="Heat soak complete!"

[gcode_macro PREHEAT_ABS]
description: Preheat for ABS with 10 minute heat soak
gcode:
    M140 S100  # Start bed heating
    M104 S245  # Start extruder heating
    M190 S100  # Wait for bed to reach temp
    M109 S245  # Wait for extruder to reach temp
    RESPOND MSG="Heat soak starting - waiting 10 minutes..."
    G4 P600000 # Wait 10 minutes (600,000ms)
    RESPOND MSG="Heat soak complete!"

#====================================================================
# CALIBRATION & TUNING
#====================================================================

[gcode_macro PA_CALIBRATE]
description: Start pressure advance calibration pattern
gcode:
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=1 ACCEL=500
    TUNING_TOWER COMMAND=SET_PRESSURE_ADVANCE PARAMETER=ADVANCE START=0 FACTOR=.005

[gcode_macro GET_POSITION_STATS]
description: Display current position information
gcode:
    {% set FH = printer.toolhead.position.z %}
    RESPOND MSG="Print Height: {FH}"
    M114

#====================================================================
# PID CALIBRATION
#====================================================================

[gcode_macro PID_BED]
description: Calibrate bed PID - Usage: PID_BED BED_TEMP=70
gcode:
    G90
    {% if printer.toolhead.homed_axes != "xyz" %}
        G28
    {% endif %}
    G1 Z10 F600
    M106
    PID_CALIBRATE HEATER=heater_bed TARGET={params.BED_TEMP|default(70)}
    M107
    {% set y_park = printer.toolhead.axis_maximum.y / 2 %}
    {% set x_park = printer.toolhead.axis_maximum.x|float - 10.0 %}
    G1 X{x_park} Y{y_park} F20000

[gcode_macro PID_HOTEND]
description: Calibrate hotend PID - Usage: PID_HOTEND HOTEND_TEMP=200
gcode:
    G90
    {% if printer.toolhead.homed_axes != "xyz" %}
        G28
    {% endif %}
    G1 Z10 F600
    M106
    PID_CALIBRATE HEATER=extruder TARGET={params.HOTEND_TEMP|default(200)}
    M107
    {% set y_park = printer.toolhead.axis_maximum.y / 2 %}
    {% set x_park = printer.toolhead.axis_maximum.x|float - 10.0 %}
    G1 X{x_park} Y{y_park} F20000

#====================================================================
# PRINT CONTROL
#====================================================================

[gcode_macro CANCEL_PRINT]
description: Cancel the running print
rename_existing: CANCEL_PRINT_BASE
gcode:
    TURN_OFF_HEATERS
    CANCEL_PRINT_BASE

#====================================================================
# BED LEVELING
#====================================================================

[gcode_macro MANUAL_LEVEL]
description: Home and calculate screw adjustments for manual leveling
gcode:
    G28
    SCREWS_TILT_CALCULATE
    G90
    {% set x_center = printer.toolhead.axis_maximum.x / 2 %}
    {% set y_center = printer.toolhead.axis_maximum.y / 2 %}
    G1 F3000 X{x_center} Y{y_center} Z25

[gcode_macro M420]
description: Load the saved default bed mesh
gcode:
    BED_MESH_PROFILE LOAD=default
