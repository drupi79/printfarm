# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Purpose

Configuration management for a home Klipper 3D printer farm. Files here are **source-of-truth configs** copied to each printer's Raspberry Pi manually (no automated deployment). The `claude_chat_archive/` folder is a historical reference — do not modify it.

## Structure

```
klipper/
  shared/           # Deployed to every printer's Klipper config dir
    macros.cfg      # Utility macros: filament load/unload, preheat, PID cal, bed leveling
    start.cfg       # PRINT_START/END, PAUSE/RESUME, adaptive meshing, M600 filament change
    start_manual_purge.cfg  # Fallback PRINT_START when LINE_PURGE isn't working
  printers/
    <name>/printer.cfg   # One per printer — includes shared files, all hardware config
orca_profiles/
  <printer>/        # OrcaSlicer printer + process profiles per machine
Printer_Backup/
  <name>/           # Full config snapshots pulled directly from a printer's Pi
                    # Includes Pi-side files not in this repo (mainsail.cfg, KAMP_Settings.cfg,
                    # moonraker.conf, crowsnest.conf, timelapse.cfg, octoeverywhere, etc.)
                    # Reference only — do not edit these; use klipper/printers/<name>/ as source of truth
```

## Config Include Hierarchy

Every `printer.cfg` includes, in this order:
```
[include mainsail.cfg]        # Mainsail web UI (lives on the Pi, not this repo)
[include KAMP_Settings.cfg]   # KAMP plugin settings (lives on the Pi, not this repo)
[include start.cfg]           # → klipper/shared/start.cfg
[include macros.cfg]          # → klipper/shared/macros.cfg
```

`mainsail.cfg` and `KAMP_Settings.cfg` are **not** in this repo — they are installed by KAMP/Mainsail on the Pi.

## Key Architectural Decisions

### Adaptive Bed Mesh (KAMP)
`start.cfg` contains a custom `BED_MESH_CALIBRATE` macro that wraps Klipper's built-in (`rename_existing: _BED_MESH_CALIBRATE`). It reads print object bounds from `exclude_object` data to probe only the area being printed. Requires `[exclude_object]` to be active (it's in `start.cfg`) and the slicer must emit `EXCLUDE_OBJECT_DEFINE` g-code.

### PRINT_START Slicer Interface
Slicers call: `PRINT_START EXTRUDER_TEMP=<n> BED_TEMP=<n>`
The macro heats bed first, homes (`_CHOME` = conditional home), runs adaptive mesh, parks (`Smart_Park` from KAMP), heats extruder, then runs `LINE_PURGE` (from KAMP). First layer accel is capped at 500.

### Probe Coordinates vs Nozzle Coordinates
`safe_z_home` uses **nozzle** coordinates. `bed_mesh` uses **probe** coordinates. These differ by the probe offset. The Ender 7 (BDsensor offset: x+35.5, y-25.5) and Neptune 3 Max (CR Touch offset: x-28.5, y+22) have detailed comments explaining the math. Always verify this when editing these sections.

### SAVE_CONFIG Block
The `#*# <--- SAVE_CONFIG --->` section at the bottom of each `printer.cfg` is auto-generated by Klipper (PID values, z_offset, input shaper from `SAVE_CONFIG` command). **Never edit this block manually.** When copying an updated config back from a printer, preserve this block.

### Printer-Specific Macro Overrides
The Ender 7 defines its own `PAUSE`/`RESUME`/`CANCEL_PRINT`/`LOAD_FILAMENT`/`UNLOAD_FILAMENT` in its `printer.cfg`, overriding the shared versions. This is intentional — CoreXY park positions and HGX Lite load distances differ from the Cartesian printers.

## Printer-Specific Notes

**Wanhao D6** (`klipper/printers/wanhao_d6/printer.cfg`):
- Board: BTT SKR Mini E3 v3.0; toolhead: BTT EBB42 on CAN bus (`canbus_uuid: 799e85ba0b4e`)
- Hotend: HICTOP Bambu Lab X1 Carbon Assembly, hardened steel 0.4mm nozzle (`sensor_type: Generic 3950`)
- BDsensor on EBBCan pins (x_offset=0, y_offset=-13); BMG direct drive (gear_ratio 57:11)
- Palette 2 connected via USB for multi-material
- Uses shared `start.cfg`/`macros.cfg` (replaced the D6's own versions)
- ⚠️ Z `rotation_distance: 4` — original D6 leadscrew is 8mm pitch; kept as-is since it's been running. Revert to 8 if Z moves wrong distance.
- This printer is the only one in the farm with a CAN bus toolhead and Palette 2

**Ender 7** (`klipper/printers/ender7/printer.cfg`):
- BDsensor: uses `no_stop_probe` for fast probing; bed_mesh limits are in probe coords
- `shaper_freq_x = 106.0Hz` is flagged ⚠️ as suspicious — re-run ADXL test before trusting
- Y input shaper is commented out (placeholder only) — must run `SHAPER_CALIBRATE` for Y
- `rotation_distance: 5.7` for HGX Lite is ~20% above typical — verify with 100mm extrusion test
- Bed mesh was cleared (corrupted) — run `BED_MESH_CALIBRATE` and `SAVE_CONFIG` before printing

**Ender 3 V2 Twins**: both run on a shared Intel NUC (two Klipper instances). Print bed is 220×220 — `position_max` is intentionally set to X=250, Y=235 so the BLTouch probe can reach all bed screws for `screws_tilt_adjust`. Do not reduce these limits. Twin 1 serial path uses `by-path` (USB port-specific); Twin 2 uses `by-id`. If the NUC is re-cabled, Twin 1's serial path will break — Twin 2 is unaffected.

**Neptune 3 Max**: uses stock inductive proximity sensor (configured as `[probe]`, not `[bltouch]`). Includes `[include timelapse.cfg]` which the Ender configs don't. `pwm_cycle_time: 0.020` (50Hz) — change to `0.0166` for 60Hz grid if bed heater causes lamp flicker.

**Ender 3 Pro** board 4.2.7: uses UART communication (not USB direct). Firmware must be compiled for UART. Print bed is 220×220 — `position_max` is intentionally set to X=250, Y=240 so the BLTouch probe can reach all four bed screws for `screws_tilt_adjust`. Do not reduce these limits.

## OrcaSlicer Profiles

Most printer folders have `printer_profile.json` plus process profiles: `quality.json`, `balanced.json`, `speed.json`, `print_in_place.json`.

Exceptions:
- **Neptune 3 Max**: also has `printer_04mm.json`, `printer_06mm.json`, and three 0.6mm process profiles (`06mm_*.json`)
- **Ender 3 Pro**: machine definitions only (`printer_profile.json`, `printer_profile_alt.json`) — no process profiles
- **K1 Max** (`orca_profiles/k1_max/`): Creality K1 Max 300×300 "Klipper OPTIMIZED" profile — no Klipper config in this repo, OrcaSlicer profiles only
- **Ender 7**: process profiles use non-standard names (`standard.json`, `standard_conservative.json`) and includes one filament profile (`filament_numakers_pla.json`)
- **Wanhao D6**: full set of profiles (`printer_profile.json`, process profiles, filament profiles for PLA/PETG/ASA)

OrcaSlicer profiles are standalone JSON; they reference each other by name strings internally. When editing, keep the `"name"` field inside the JSON consistent with the filename convention.

## Deploying Configs to a Printer

Copy the relevant files to the printer's Pi (typically `~/printer_data/config/` or `~/klipper_config/`):
```bash
# Example for Ender 7
scp klipper/shared/macros.cfg klipper/shared/start.cfg pi@ender7:~/printer_data/config/
scp klipper/printers/ender7/printer.cfg pi@ender7:~/printer_data/config/
```
Then restart Klipper via Mainsail or `sudo systemctl restart klipper`.
